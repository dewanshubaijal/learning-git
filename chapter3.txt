This is chapter 3, updated version.